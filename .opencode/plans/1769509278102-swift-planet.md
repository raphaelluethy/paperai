# Chat Persistence & History Implementation Plan

## Overview
Implement chat persistence, conversation history, new chat creation, timestamps, and task duration tracking in the PaperAI application.

## Current State Analysis

### Existing Infrastructure
- **Database**: PostgreSQL with Drizzle ORM
  - `conversations` table: stores chat sessions with `sessionId` for SDK resumption
  - `messages` table: stores individual messages with `createdAt` timestamps and `agentActivity` JSON
- **Agent SDK**: Claude Agent SDK supports session resumption via `resume` and `persistSession` options
- **API**: REST endpoints exist for fetching conversations (`/api/projects/:id/conversations`) and individual conversation details
- **WebSocket**: Real-time chat via WebSocket with conversation creation on first message

### Current Gaps
1. No UI to view conversation history
2. No way to create a new chat (always continues existing conversation)
3. No timestamps displayed on messages
4. No task duration shown in UI (though tracked in agentActivity)
5. No way to resume old conversations or view them read-only

## Implementation Plan

### Phase 1: Database Schema Updates
**File**: `src/server/db/schema.ts`

Add `updatedAt` and `title` fields to conversations for better history management:

```typescript
export const conversations = pgTable("conversations", {
  id: uuid("id").primaryKey().defaultRandom(),
  projectId: uuid("project_id")
    .references(() => projects.id, { onDelete: "cascade" })
    .notNull(),
  sessionId: text("session_id"),
  title: text("title"), // First message preview or user-editable title
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(), // Track last activity
})
```

**Migration needed**: Yes, add `title` and `updatedAt` columns

### Phase 2: Backend API Enhancements
**File**: `src/server/api/chat.ts`

1. **Update conversation creation** to set title from first user message
2. **Add DELETE endpoint** for conversations
3. **Add PUT endpoint** to update conversation title
4. **Update WebSocket handler** to support resuming conversations by ID

### Phase 3: Frontend Store Updates
**File**: `src/client/stores/chatStore.ts`

Add:
- `conversations` store to hold conversation list
- `currentConversationId` signal
- `isReadOnly` signal for viewing old chats
- `fetchConversations()` method
- `loadConversation(id)` method to load historical messages
- `createNewConversation()` method
- `deleteConversation(id)` method
- Update message type to include `createdAt` from server

### Phase 4: Chat History Sidebar Component
**New File**: `src/client/components/ChatHistory.tsx`

Create a sidebar component showing:
- "New Chat" button at top
- List of conversations sorted by `updatedAt` desc
- Conversation title (or preview of first message)
- Timestamp of last activity
- Active conversation highlighting
- Delete conversation option (with confirmation)

### Phase 5: MessageList Enhancements
**File**: `src/client/components/MessageList.tsx`

Add:
- Timestamp display for each message
- Relative time formatting (e.g., "2 minutes ago", "Today at 3:45 PM")
- Hover to show exact timestamp

### Phase 6: AgentActivityTree Duration Display
**File**: `src/client/components/AgentActivityTree.tsx`

Enhance to show:
- Duration for completed tasks (endTime - startTime)
- Running time for active tasks (current time - startTime)
- Human-readable format (e.g., "1.5s", "2m 30s")

### Phase 7: ChatInterface Updates
**File**: `src/client/components/ChatInterface.tsx`

Add:
- Read-only mode indicator when viewing old chats
- Disable input when in read-only mode
- Show "Resume Chat" button for old conversations (if we want to support resuming)
- OR show "View Only" indicator if not resuming

### Phase 8: App.tsx Integration
**File**: `src/client/App.tsx`

- Add ChatHistory sidebar next to ProjectList or integrate into chat tab
- Handle conversation selection

## Technical Decisions

### Session Resumption Strategy
The Claude Agent SDK supports session resumption via the `resume` option. However, for simplicity and predictability:

**Option A**: Allow resuming old sessions
- Pros: Full conversation continuity with agent context
- Cons: Agent may behave unexpectedly with old context, more complex

**Option B**: Read-only mode for old chats (RECOMMENDED)
- Pros: Simple, predictable, clear separation between active and historical chats
- Cons: Cannot continue old conversations

**Decision**: Implement Option B with read-only mode. Users can view history but must create new chat to continue. This matches user expectations from ChatGPT/Claude interfaces.

### Conversation Title Generation
- Auto-generate from first 50 characters of first user message
- Allow inline editing by clicking title
- Fall back to "New Chat" if no messages

### Timestamp Display Format
- Messages < 24h old: "Today at 3:45 PM" or "2 hours ago"
- Messages < 7 days: "Monday at 3:45 PM"
- Older: "Jan 15, 2026 at 3:45 PM"

### Task Duration Format
- < 1s: "0.8s"
- < 60s: "12.5s"
- < 1h: "2m 30s"
- >= 1h: "1h 15m"

## File Changes Summary

### Modified Files
1. `src/server/db/schema.ts` - Add title and updatedAt to conversations
2. `src/server/api/chat.ts` - Update conversation endpoints, WebSocket resume support
3. `src/client/stores/chatStore.ts` - Add conversation management
4. `src/client/components/MessageList.tsx` - Add timestamps
5. `src/client/components/AgentActivityTree.tsx` - Add duration display
6. `src/client/components/ChatInterface.tsx` - Add read-only mode
7. `src/client/App.tsx` - Integrate chat history

### New Files
1. `src/client/components/ChatHistory.tsx` - Conversation list sidebar
2. `drizzle/migrations/XXXX_add_conversation_fields.sql` - Database migration

## Verification Steps

1. **Create new project** → Verify project creates successfully
2. **Send first message** → Verify conversation created with title from message
3. **Send more messages** → Verify messages appear with timestamps
4. **Check agent activity** → Verify task durations shown
5. **Create new chat** → Verify new conversation started, old one saved
6. **View chat history** → Verify list shows all conversations
7. **Click old conversation** → Verify loads in read-only mode
8. **Delete conversation** → Verify removed from list and database
9. **Refresh page** → Verify conversations persist

## Migration Commands

```bash
# Generate migration
bun drizzle-kit generate

# Apply migration
bun drizzle-kit migrate
```

## Open Questions

1. Should we support renaming conversations? (Recommended: Yes)
2. Should we show message count in conversation list? (Recommended: Optional)
3. Should old conversations show the agent activity tree from when they ran? (Recommended: Yes, load from database)
